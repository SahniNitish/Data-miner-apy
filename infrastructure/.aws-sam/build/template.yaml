AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: APY Data Miner - Daily Uniswap V3 Data Collection Pipeline
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
    - dev
    - prod
    Description: Deployment environment
  AlchemyApiKey:
    Type: String
    NoEcho: true
    Description: Alchemy API key for Ethereum access
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Password for RDS database
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for VPC
Globals:
  Function:
    Timeout: 900
    MemorySize: 1024
    Runtime: nodejs18.x
    Environment:
      Variables:
        ENVIRONMENT:
          Ref: Environment
        DB_SSL: 'true'
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: VpcCidr
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
      - Key: Name
        Value:
          Fn::Sub: apy-data-miner-${Environment}-vpc
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
        - 0
        - Fn::GetAZs: ''
      CidrBlock:
        Fn::Select:
        - 0
        - Fn::Cidr:
          - Ref: VpcCidr
          - 4
          - 8
      Tags:
      - Key: Name
        Value:
          Fn::Sub: apy-data-miner-${Environment}-private-1
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
        - 1
        - Fn::GetAZs: ''
      CidrBlock:
        Fn::Select:
        - 1
        - Fn::Cidr:
          - Ref: VpcCidr
          - 4
          - 8
      Tags:
      - Key: Name
        Value:
          Fn::Sub: apy-data-miner-${Environment}-private-2
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
        - 0
        - Fn::GetAZs: ''
      CidrBlock:
        Fn::Select:
        - 2
        - Fn::Cidr:
          - Ref: VpcCidr
          - 4
          - 8
      MapPublicIpOnLaunch: true
      Tags:
      - Key: Name
        Value:
          Fn::Sub: apy-data-miner-${Environment}-public-1
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId:
        Ref: InternetGateway
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet1
      RouteTableId:
        Ref: PublicRouteTable
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: VPCGatewayAttachment
    Properties:
      Domain: vpc
  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId:
        Fn::GetAtt:
        - NATGatewayEIP
        - AllocationId
      SubnetId:
        Ref: PublicSubnet1
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      DestinationCidrBlock: '0.0.0.0/0'
      NatGatewayId:
        Ref: NATGateway
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet1
      RouteTableId:
        Ref: PrivateRouteTable
  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PrivateSubnet2
      RouteTableId:
        Ref: PrivateRouteTable
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId:
        Ref: VPC
      SecurityGroupEgress:
      - IpProtocol: -1
        CidrIp: '0.0.0.0/0'
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS
      VpcId:
        Ref: VPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        SourceSecurityGroupId:
          Ref: LambdaSecurityGroup
  AlchemySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name:
        Fn::Sub: apy-data-miner/${Environment}/alchemy
      Description: Alchemy API credentials
      SecretString:
        Fn::Sub: '{"ALCHEMY_API_KEY": "${AlchemyApiKey}"}'
  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name:
        Fn::Sub: apy-data-miner/${Environment}/database
      Description: Database credentials
      SecretString:
        Fn::Sub: "{\n  \"username\": \"apyminer\",\n  \"password\": \"${DBPassword}\"\
          ,\n  \"host\": \"${Database.Endpoint.Address}\",\n  \"port\": 5432,\n  \"\
          database\": \"apyminer\"\n}\n"
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for APY Data Miner RDS
      SubnetIds:
      - Ref: PrivateSubnet1
      - Ref: PrivateSubnet2
  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier:
        Fn::Sub: apy-data-miner-${Environment}
      DBInstanceClass:
        Fn::If:
        - IsProd
        - db.t3.small
        - db.t3.micro
      Engine: postgres
      EngineVersion: '16.6'
      MasterUsername: apyminer
      MasterUserPassword:
        Ref: DBPassword
      DBName: apyminer
      AllocatedStorage: 20
      MaxAllocatedStorage: 100
      StorageType: gp3
      VPCSecurityGroups:
      - Ref: DatabaseSecurityGroup
      DBSubnetGroupName:
        Ref: DBSubnetGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 7
      DeletionProtection:
        Fn::If:
        - IsProd
        - true
        - false
      Tags:
      - Key: Environment
        Value:
          Ref: Environment
  CollectorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: apy-data-miner-collector-${Environment}
      Description: Daily collector for Uniswap V3 swap transactions
      CodeUri: CollectorFunction
      Handler: index.handler
      Timeout: 900
      MemorySize: 1024
      VpcConfig:
        SecurityGroupIds:
        - Ref: LambdaSecurityGroup
        SubnetIds:
        - Ref: PrivateSubnet1
        - Ref: PrivateSubnet2
      Environment:
        Variables:
          SECRETS_ARN:
            Ref: AlchemySecret
          DB_SECRETS_ARN:
            Ref: DatabaseSecret
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - Ref: AlchemySecret
          - Ref: DatabaseSecret
        - Effect: Allow
          Action:
          - ec2:CreateNetworkInterface
          - ec2:DescribeNetworkInterfaces
          - ec2:DeleteNetworkInterface
          Resource: '*'
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 * * ? *)
            Description: Trigger daily data collection
            Enabled: true
    Metadata:
      SamResourceId: CollectorFunction
  CollectorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName:
        Fn::Sub: apy-data-miner-collector-errors-${Environment}
      AlarmDescription: Alert when collector Lambda fails
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 86400
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
      - Name: FunctionName
        Value:
          Ref: CollectorFunction
      TreatMissingData: notBreaching
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName:
        Fn::Sub: apy-data-miner-alerts-${Environment}
      DisplayName: APY Data Miner Alerts
Conditions:
  IsProd:
    Fn::Equals:
    - Ref: Environment
    - prod
Outputs:
  CollectorFunctionArn:
    Description: Collector Lambda ARN
    Value:
      Fn::GetAtt:
      - CollectorFunction
      - Arn
  DatabaseEndpoint:
    Description: RDS PostgreSQL endpoint
    Value:
      Fn::GetAtt:
      - Database
      - Endpoint.Address
  DatabasePort:
    Description: RDS PostgreSQL port
    Value:
      Fn::GetAtt:
      - Database
      - Endpoint.Port
  VpcId:
    Description: VPC ID
    Value:
      Ref: VPC
  AlertTopicArn:
    Description: SNS Topic ARN for alerts
    Value:
      Ref: AlertTopic
